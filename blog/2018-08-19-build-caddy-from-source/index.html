<!doctype html><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/themes/geos2/res/apple-touch-icon-144x144.png><link rel=apple-touch-icon-precomposed sizes=152x152 href=/themes/geos2/res/apple-touch-icon-152x152.png><link rel=icon type=image/png href=/themes/geos2/res/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/themes/geos2/res/favicon-16x16.png sizes=16x16><script data-goatcounter=https://radhifadlillah.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<link href=/themes/geos2/css/fonts.css rel=stylesheet><link href=/themes/geos2/css/index.css rel=stylesheet><title>Step by Step: Build Caddy From the Source - Radhi Fadlillah</title><div class=file-page><div class="window reader"><div class=window__header><p class=window__header__title>Step by Step: Build Caddy From the Source (22/8/18)</div><div class="window__status-bar url-trail file-page__url-trail"><a href=/ class=url-trail__item>&lt;root></a>
<a href=/blog class=url-trail__item>blog</a>
<a href=/blog/2018-08-19-build-caddy-from-source class=url-trail__item>&lt;current-file></a></div><div class="window__content reader__content"><p>After finished <a href=./2018-08-18-setting-up-a-new-vps>setting up</a> my VPS, next I want to install <a href=https://caddyserver.com>Caddy</a> as my web server. Even though Caddy is still quite new, I prefer using it rather than the existing web server like Apache or Nginx. The reasons are :<ul><li>It's the only web server that uses HTTPS by default.<li>It's easy to configure. For example, to enable HTTPs we only need to write 3-line configuration file.<li>Because it's written in Go, it's only use single binary without any dependencies, which make it really easy to install.<li>It's production ready and has been <a href=https://caddyserver.com/stats>used</a> by many people.</ul><p>While Caddy already provides a <a href=https://caddyserver.com/download>precompiled</a> binary, it's only free for personal use. In other hand, I still don't have the privilege to pay the monthly payment for the commercial license. Fortunately, that limitation only implemented for the precompiled binary. That means we still can use Caddy for free even for commercial use, as long as we built it from the source.<h3 id=table-of-contents>Table of Contents</h3><ol><li><a href=#install-go>Install Go</a><li><a href=#download-caddy-and-its-plugin>Download Caddy and Its Plugin</a><li><a href=#build-caddy>Build Caddy</a><li><a href=#run-caddy>Run Caddy</a></ol><h3 id=install-go>Install Go</h3><p>First, <a href=https://golang.org/dl/>download</a> the latest Go version to your VPS. When this post is written, the latest version is 1.10.3 :<pre tabindex=0 class=chroma><code><span class=line><span class=cl>wget https://dl.google.com/go/go1.10.3.linux-amd64.tar.gz
</span></span></code></pre><p>Next, extract the downloaded file into <code>/usr/local</code>, creating a Go tree in <code>/usr/local/go</code> :<pre tabindex=0 class=chroma><code><span class=line><span class=cl>sudo tar -C /usr/local -xzf go1.10.3.linux-amd64.tar.gz
</span></span></code></pre><p>Add <code>/usr/local/go/bin</code> to the <code>PATH</code> environment variable, either in your <code>/etc/profile</code> (for a system-wide installation) or <code>$HOME/.profile</code>. Open the profile file using <code>nano</code> or your preferred editor, then add these lines to the end of file :<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=nv>$PATH</span>:/usr/local/go/bin
</span></span></code></pre><p>For conveniance, you should add the Go workspace's <code>bin</code> subdirectory to your <code>PATH</code> to let you run the compiled Go program directly. Open the profile file again then add following lines :<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nb>export</span> <span class=nv>GOPATH</span><span class=o>=</span><span class=k>$(</span>go env GOPATH<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=nv>$PATH</span>:<span class=nv>$GOPATH</span>/bin
</span></span></code></pre><p>Once finished, save and close the profile file. To apply the change, run <code>source</code> to your profile file :<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nb>source</span> <span class=nv>$HOME</span>/.profile
</span></span></code></pre><p>Now, <code>go</code> should be installed on your system. To test it, run <code>go env</code> which should give you output like this :<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nv>GOARCH</span><span class=o>=</span><span class=s2>&#34;amd64&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GOBIN</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GOCACHE</span><span class=o>=</span><span class=s2>&#34;/home/radhi/.cache/go-build&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GOEXE</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GOHOSTARCH</span><span class=o>=</span><span class=s2>&#34;amd64&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GOHOSTOS</span><span class=o>=</span><span class=s2>&#34;linux&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GOOS</span><span class=o>=</span><span class=s2>&#34;linux&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GOPATH</span><span class=o>=</span><span class=s2>&#34;/home/radhi/go&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GORACE</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GOROOT</span><span class=o>=</span><span class=s2>&#34;/usr/local/go&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GOTMPDIR</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GOTOOLDIR</span><span class=o>=</span><span class=s2>&#34;/usr/local/go/pkg/tool/linux_amd64&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GCCGO</span><span class=o>=</span><span class=s2>&#34;gccgo&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>CC</span><span class=o>=</span><span class=s2>&#34;gcc&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>CXX</span><span class=o>=</span><span class=s2>&#34;g++&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>CGO_ENABLED</span><span class=o>=</span><span class=s2>&#34;1&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>CGO_CFLAGS</span><span class=o>=</span><span class=s2>&#34;-g -O2&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>CGO_CPPFLAGS</span><span class=o>=</span><span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>CGO_CXXFLAGS</span><span class=o>=</span><span class=s2>&#34;-g -O2&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>CGO_FFLAGS</span><span class=o>=</span><span class=s2>&#34;-g -O2&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>CGO_LDFLAGS</span><span class=o>=</span><span class=s2>&#34;-g -O2&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>PKG_CONFIG</span><span class=o>=</span><span class=s2>&#34;pkg-config&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>GOGCCFLAGS</span><span class=o>=</span><span class=s2>&#34;-fPIC -m64 -pthread -fno-caret-diagnostics -Qunused-arguments -fmessage-length=0 -fdebug-prefix-map=/tmp/go-build238814194=/tmp/go-build -gno-record-gcc-switches&#34;</span>
</span></span></code></pre><h3 id=download-caddy-and-its-plugin>Download Caddy and Its Plugin</h3><p>To build Caddy from source, run these commands :<pre tabindex=0 class=chroma><code><span class=line><span class=cl>go get -u -v github.com/mholt/caddy/caddy
</span></span><span class=line><span class=cl>go get -u -v github.com/caddyserver/builds
</span></span></code></pre><p>Next download the plugin that you want to use. In my case, I will use these plugins :<ul><li><a href=https://github.com/abiosoft/caddy-git>git</a>, the git plugin that make it possible to deploy a site with a simple git push.<li><a href=https://github.com/caddyserver/dnsproviders/tree/master/cloudflare>dns.cloudflare</a>, which allows you to obtain certificates using DNS records for domains managed with Cloudflare.</ul><p>To download these plugins, run :<pre tabindex=0 class=chroma><code><span class=line><span class=cl>go get -u -v github.com/abiosoft/caddy-git
</span></span><span class=line><span class=cl>go get -u -v github.com/caddyserver/dnsproviders/cloudflare
</span></span></code></pre><h3 id=build-caddy>Build Caddy</h3><p>Before building Caddy, we have to include the plugins to the Caddy's source code. First, set working directory to Caddy's directory :<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nb>cd</span> <span class=nv>$GOPATH</span>/src/github.com/mholt/caddy/caddy
</span></span></code></pre><p>Next, open the <code>caddymain/run.go</code> and add imports link for packages of the plugins that you want to install :<pre tabindex=0 class=chroma><code><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;github.com/abiosoft/caddy-git&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>_</span> <span class=s>&#34;github.com/caddyserver/dnsproviders/cloudflare&#34;</span>
</span></span></code></pre><p>Save and close the file. Next, still in the <code>caddy</code> directory, build Caddy by running :<pre tabindex=0 class=chroma><code><span class=line><span class=cl>go install
</span></span></code></pre><p>Once finished, you can run Caddy by using <code>caddy</code> command.<h3 id=run-caddy>Run Caddy</h3><p>As web server, Caddy will need the access to port 80 (HTTP) and 443 (HTTPs). To do so, we need to let Caddy to listen to port &lt; 1024 by running :<pre tabindex=0 class=chroma><code><span class=line><span class=cl>sudo setcap <span class=nv>cap_net_bind_service</span><span class=o>=</span>+ep <span class=nv>$GOPATH</span>/bin/caddy
</span></span></code></pre><p>Next we need to increase the maximum number of open files in our server. To do this, we need to increase the limit of file descriptor by running :<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nb>ulimit</span> -n <span class=m>8192</span>
</span></span></code></pre><p>Now we could run Caddy in background as the web server. There are several ways to do this. First is by making Caddy as service for init system. The second one is easier, by using <code>nohup &</code>. The full command is like this :<pre tabindex=0 class=chroma><code><span class=line><span class=cl>nohup caddy -conf <span class=s2>&#34;/path/to/Caddyfile&#34;</span> &gt;&gt; ~/Caddy.log 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>&amp;</span>
</span></span></code></pre><p>The command above will run <code>caddy</code> in background and put the log file in <code>$HOME/Caddy.log</code>. To make Caddy run when the server start, you can use the <a href=https://en.wikipedia.org/wiki/Cron>cron</a> job. To do this, first open the configuration file by running :<pre tabindex=0 class=chroma><code><span class=line><span class=cl>crontab -e
</span></span></code></pre><p>Next add these lines to the end of file :<pre tabindex=0 class=chroma><code><span class=line><span class=cl>@reboot . <span class=nv>$HOME</span>/.profile <span class=o>&amp;&amp;</span> nohup caddy -conf <span class=s2>&#34;/path/to/Caddyfile&#34;</span> &gt;&gt; ~/Caddy.log 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>&amp;</span>
</span></span></code></pre><p>Save and close the configuration file. The <code>@reboot</code> syntax means the command in that line will be run after every reboot on the system. The <code>. $HOME/.profile</code> is used to load environment variable that defined by the profile file. This is done because <code>cron</code> is started before the <code>.profile</code> file is loaded, so we need to load it manually.<h3 id=finished>Finished</h3><p>At this point, Caddy has been installed on your system and will run automatically when system starts. You should check the <a href=https://caddyserver.com/docs>documentation</a> to learn how to create Caddyfile and activate the HTTPs for your site.<div class=reader__tags><p>Tags:</p><a href=/blog/tag-caddy>#caddy</a>
<a href=/blog/tag-linux>#linux</a>
<a href=/blog/tag-sysadmin>#sysadmin</a>
<a href=/blog/tag-tutorial>#tutorial</a></div><div class=reader__sibling><a href=/blog/2018-08-18-setting-up-a-new-vps class=reader__sibling__prev>Step by Step: Setting Up a New VPS</a>
<a href=/blog/2018-08-23-problems-with-to-do-list class=reader__sibling__next>Instead of Writing a To-Do List, Choose One Task that MUST Get Done</a></div></div><div class=window__footer></div></div></div>