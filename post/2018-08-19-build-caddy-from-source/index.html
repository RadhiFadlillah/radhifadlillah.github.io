<!doctype html><html>
<head>
<title>Step by Step: Build Caddy From the Source - Radhi Fadlillah</title>
<meta name=twitter:title content="Step by Step: Build Caddy From the Source - Radhi Fadlillah">
<meta property=og:title content="Step by Step: Build Caddy From the Source - Radhi Fadlillah">
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=description content="After finished setting up my VPS, next I want to install Caddy as my web server. Even though Caddy is still quite new, I prefer using it rather than the existing web server like Apache or Nginx. The reasons are :">
<meta name=twitter:description content="After finished setting up my VPS, next I want to install Caddy as my web server. Even though Caddy is still quite new, I prefer using it rather than the existing web server like Apache or Nginx. The reasons are :">
<meta property=og:description content="After finished setting up my VPS, next I want to install Caddy as my web server. Even though Caddy is still quite new, I prefer using it rather than the existing web server like Apache or Nginx. The reasons are :">
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700">
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700">
<link rel=stylesheet href=/css/stylesheet.css>
<link rel=stylesheet href=/css/dracula.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=/res/apple-touch-icon-144x144.png>
<link rel=apple-touch-icon-precomposed sizes=152x152 href=/res/apple-touch-icon-152x152.png>
<link rel=icon type=image/png href=/res/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/res/favicon-16x16.png sizes=16x16>
<link rel="shortcut icon" href=/res/favicon.ico>
</head>
<body>
<div id=header>
<div class=content>
<a id=text-logo href=/>Radhi Fadlillah</a>
<div class=spacer></div>
<a href=/page/about class=header-link>About</a>
</div>
</div>
<div id=body>
<div class=content id=content-post>
<div id=post-metadata>
<a id=post-category href=/category/tutorial>
tutorial
</a>
<p id=post-title>Step by Step: Build Caddy From the Source</p>
<div id=post-time>
<p id=post-author>Radhi Fadlillah</p>
<p id=post-created>2018-08-19 17:13</p>
<p id=post-updated><i>Last updated 2018-08-22 06:54</i></p>
</div>
</div>
<div id=post-html class=content-html><html><head></head><body><p>After finished <a href=/post/2018-08-18-setting-up-a-new-vps>setting up</a> my VPS, next I want to install <a href=https://caddyserver.com>Caddy</a> as my web server. Even though Caddy is still quite new, I prefer using it rather than the existing web server like Apache or Nginx. The reasons are :</p>
<ul>
<li>It’s the only web server that uses HTTPS by default.</li>
<li>It’s easy to configure. For example, to enable HTTPs we only need to write 3-line configuration file.</li>
<li>Because it’s written in Go, it’s only use single binary without any dependencies, which make it really easy to install.</li>
<li>It’s production ready and has been <a href=https://caddyserver.com/stats>used</a> by many people.</li>
</ul>
<p>While Caddy already provides a <a href=https://caddyserver.com/download>precompiled</a> binary, it’s only free for personal use. In other hand, I still don’t have the privilege to pay the monthly payment for the commercial license. Fortunately, that limitation only implemented for the precompiled binary. That means we still can use Caddy for free even for commercial use, as long as we built it from the source.</p>
<h3 id=table-of-contents>Table of Contents</h3>
<ol>
<li><a href=#install-go>Install Go</a></li>
<li><a href=#download-caddy-and-its-plugin>Download Caddy and Its Plugin</a></li>
<li><a href=#build-caddy>Build Caddy</a></li>
<li><a href=#run-caddy>Run Caddy</a></li>
</ol>
<h3 id=install-go>Install Go</h3>
<p>First, <a href=https://golang.org/dl/>download</a> the latest Go version to your VPS. When this post is written, the latest version is 1.10.3 :</p>
<pre><code class=language-bash><pre class=chroma>wget https://dl.google.com/go/go1.10.3.linux-amd64.tar.gz</pre></code></pre>
<p>Next, extract the downloaded file into <code>/usr/local</code>, creating a Go tree in <code>/usr/local/go</code> :</p>
<pre><code class=language-bash><pre class=chroma>sudo tar -C /usr/local -xzf go1.10.3.linux-amd64.tar.gz</pre></code></pre>
<p>Add <code>/usr/local/go/bin</code> to the <code>PATH</code> environment variable, either in your <code>/etc/profile</code> (for a system-wide installation) or <code>$HOME/.profile</code>. Open the profile file using <code>nano</code> or your preferred editor, then add these lines to the end of file :</p>
<pre><code class=language-bash><pre class=chroma>export PATH=$PATH:/usr/local/go/bin</pre></code></pre>
<p>For conveniance, you should add the Go workspace’s <code>bin</code> subdirectory to your <code>PATH</code> to let you run the compiled Go program directly. Open the profile file again then add following lines :</p>
<pre><code class=language-bash><pre class=chroma>export GOPATH=$(go env GOPATH)
export PATH=$PATH:$GOPATH/bin</pre></code></pre>
<p>Once finished, save and close the profile file. To apply the change, run <code>source</code> to your profile file :</p>
<pre><code class=language-bash><pre class=chroma>source $HOME/.profile</pre></code></pre>
<p>Now, <code>go</code> should be installed on your system. To test it, run <code>go env</code> which should give you output like this :</p>
<pre><code class=language-bash><pre class=chroma>GOARCH=&#34;amd64&#34;
GOBIN=&#34;&#34;
GOCACHE=&#34;/home/radhi/.cache/go-build&#34;
GOEXE=&#34;&#34;
GOHOSTARCH=&#34;amd64&#34;
GOHOSTOS=&#34;linux&#34;
GOOS=&#34;linux&#34;
GOPATH=&#34;/home/radhi/go&#34;
GORACE=&#34;&#34;
GOROOT=&#34;/usr/local/go&#34;
GOTMPDIR=&#34;&#34;
GOTOOLDIR=&#34;/usr/local/go/pkg/tool/linux_amd64&#34;
GCCGO=&#34;gccgo&#34;
CC=&#34;gcc&#34;
CXX=&#34;g++&#34;
CGO_ENABLED=&#34;1&#34;
CGO_CFLAGS=&#34;-g -O2&#34;
CGO_CPPFLAGS=&#34;&#34;
CGO_CXXFLAGS=&#34;-g -O2&#34;
CGO_FFLAGS=&#34;-g -O2&#34;
CGO_LDFLAGS=&#34;-g -O2&#34;
PKG_CONFIG=&#34;pkg-config&#34;
GOGCCFLAGS=&#34;-fPIC -m64 -pthread -fno-caret-diagnostics -Qunused-arguments -fmessage-length=0 -fdebug-prefix-map=/tmp/go-build238814194=/tmp/go-build -gno-record-gcc-switches&#34;</pre></code></pre>
<h3 id=download-caddy-and-its-plugin>Download Caddy and Its Plugin</h3>
<p>To build Caddy from source, run these commands :</p>
<pre><code class=language-bash><pre class=chroma>go get -u -v github.com/mholt/caddy/caddy
go get -u -v github.com/caddyserver/builds</pre></code></pre>
<p>Next download the plugin that you want to use. In my case, I will use these plugins :</p>
<ul>
<li><a href=https://github.com/abiosoft/caddy-git>git</a>, the git plugin that make it possible to deploy a site with a simple git push.</li>
<li><a href=https://github.com/caddyserver/dnsproviders/tree/master/cloudflare>dns.cloudflare</a>, which allows you to obtain certificates using DNS records for domains managed with Cloudflare.</li>
</ul>
<p>To download these plugins, run :</p>
<pre><code class=language-bash><pre class=chroma>go get -u -v github.com/abiosoft/caddy-git
go get -u -v github.com/caddyserver/dnsproviders/cloudflare</pre></code></pre>
<h3 id=build-caddy>Build Caddy</h3>
<p>Before building Caddy, we have to include the plugins to the Caddy’s source code. First, set working directory to Caddy’s directory :</p>
<pre><code class=language-bash><pre class=chroma>cd $GOPATH/src/github.com/mholt/caddy/caddy</pre></code></pre>
<p>Next, open the <code>caddymain/run.go</code> and add imports link for packages of the plugins that you want to install :</p>
<pre><code class=language-go><pre class=chroma>    _ &#34;github.com/abiosoft/caddy-git&#34;
    _ &#34;github.com/caddyserver/dnsproviders/cloudflare&#34;</pre></code></pre>
<p>Save and close the file. Next, still in the <code>caddy</code> directory, build Caddy by running :</p>
<pre><code class=language-bash><pre class=chroma>go install</pre></code></pre>
<p>Once finished, you can run Caddy by using <code>caddy</code> command.</p>
<h3 id=run-caddy>Run Caddy</h3>
<p>As web server, Caddy will need the access to port 80 (HTTP) and 443 (HTTPs). To do so, we need to let Caddy to listen to port &lt; 1024 by running :</p>
<pre><code class=language-bash><pre class=chroma>sudo setcap cap_net_bind_service=+ep $GOPATH/bin/caddy</pre></code></pre>
<p>Next we need to increase the maximum number of open files in our server. To do this, we need to increase the limit of file descriptor by running :</p>
<pre><code class=language-bash><pre class=chroma>ulimit -n 8192</pre></code></pre>
<p>Now we could run Caddy in background as the web server. There are several ways to do this. First is by making Caddy as service for init system. The second one is easier, by using <code>nohup &amp;</code>. The full command is like this :</p>
<pre><code class=language-bash><pre class=chroma>nohup caddy -conf &#34;/path/to/Caddyfile&#34; &gt;&gt; ~/Caddy.log 2&gt;&amp;1 &amp;</pre></code></pre>
<p>The command above will run <code>caddy</code> in background and put the log file in <code>$HOME/Caddy.log</code>. To make Caddy run when the server start, you can use the <a href=https://en.wikipedia.org/wiki/Cron>cron</a> job. To do this, first open the configuration file by running :</p>
<pre><code class=language-bash><pre class=chroma>crontab -e</pre></code></pre>
<p>Next add these lines to the end of file :</p>
<pre><code class=language-bash><pre class=chroma>@reboot . $HOME/.profile &amp;&amp; nohup caddy -conf &#34;/path/to/Caddyfile&#34; &gt;&gt; ~/Caddy.log 2&gt;&amp;1 &amp;</pre></code></pre>
<p>Save and close the configuration file. The <code>@reboot</code> syntax means the command in that line will be run after every reboot on the system. The <code>. $HOME/.profile</code> is used to load environment variable that defined by the profile file. This is done because <code>cron</code> is started before the <code>.profile</code> file is loaded, so we need to load it manually.</p>
<h3 id=finished>Finished</h3>
<p>At this point, Caddy has been installed on your system and will run automatically when system starts. You should check the <a href=https://caddyserver.com/docs>documentation</a> to learn how to create Caddyfile and activate the HTTPs for your site.</p>
</body></html></div>
<div id=post-tags>
<a href=/tag/caddy># caddy</a>
<a href=/tag/linux># linux</a>
<a href=/tag/sysadmin># sysadmin</a>
<a href=/tag/tutorial># tutorial</a>
<a href=/tag/vps># vps</a>
<a href=/tag/webserver># webserver</a>
</div>
</div>
</div>
<div id=footer>
<div class=content>
<p>© 2019 Radhi Fadlillah. Made with <a href=https://github.com/go-spook/spook>Spook</a>
using the <a href=https://github.com/go-spook/basic-theme>Basic</a> theme.</p>
</div>
</div>
</body>
</html>